# 四个修复方案

## 1. 图片不随页面滚动
**问题描述**：使用 `place()` 创建的浮动 `Label` 图片固定在编辑器坐标系，滚动文本时图片不会随之移动。

**解决思路**：
1. 取消浮动图片逻辑，始终使用 `Text.image_create()` 将图片嵌入文本流。
2. 拖动时通过删除并在新索引插入图片的方式实现位置变动，而非 `Label.place()`。
3. 移除 `floating_images` 数据结构及 `toggle_floating_image_draggable()`，统一使用 `toggle_image_draggable()`。

**关键修改点**：
- 删除/重构 1600 行附近涉及 `place()` 的代码。
- 更新拖动开始、移动与结束逻辑，使用 `Text` 坐标索引而非绝对坐标。

---
## 2. 粘贴格式后切换标签页格式丢失
**问题描述**：`save_current_tab_state()` 仅保存 `color_` 开头的标签，自定义格式标签（如 `format_时间戳`、`size_` 等）未保存，切换标签后丢失格式。

**解决思路**：
1. 扩展保存范围：`tag_name.startswith(('color_', 'size_', 'font_', 'underline', 'format_'))`。
2. `load_tab_content()` 同理恢复全部相关标签。

**关键修改点**：
- 约 610 行 `save_current_tab_state()` 与 `load_tab_content()` 处循环条件。

---
## 3. 粘贴内容出现两次
**问题描述**：全局 `<Control-v>` 绑定手动调用 `event_generate('<<Paste>>')`，与 `Text` 默认 Ctrl+V 行为叠加。

**解决思路**：
1. 移除根窗口的 Ctrl+V 绑定；或
2. 改为绑定在 `Text` 组件并 `return 'break'` 阻断默认处理。

**关键修改点**：
- 约 165 行键盘快捷键绑定部分。

---
## 4. 复制粘贴无法携带格式
**问题描述**：当前仅复制纯文本，无法同步标签信息。

**解决思路**：
### 复制阶段
```python
selected_text = self.text_editor.get(tk.SEL_FIRST, tk.SEL_LAST)
start = self.text_editor.index(tk.SEL_FIRST)
end = self.text_editor.index(tk.SEL_LAST)
metadata = {}
for tag in self.text_editor.tag_names(start):
    if tag in self.text_editor.tag_names():
        ranges = self.text_editor.tag_ranges(tag)
        # 仅保存与选区相交的范围
        metadata[tag] = [...]
package = json.dumps({'__richtext__': True, 'text': selected_text, 'tags': metadata})
self.root.clipboard_clear()
self.root.clipboard_append(package)
self.copied_richtext = package
```

### 粘贴阶段
```python
clip = self.root.clipboard_get()
try:
    data = json.loads(clip)
    if data.get('__richtext__'):
        self.text_editor.insert(tk.INSERT, data['text'])
        for tag, ranges in data['tags'].items():
            self.text_editor.tag_config(...)
            for r in ranges:
                self.text_editor.tag_add(tag, r[0], r[1])
        return
except Exception:
    pass  # 回退到纯文本粘贴
self.text_editor.event_generate('<<Paste>>')
```

**关键修改点**：
- 新建内部属性 `self.copied_richtext`。
- 重写 `copy()`、`paste()` 函数。